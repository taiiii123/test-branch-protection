name: Branch Update Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  check-latest-main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Fetch latest main
        run: |
          git fetch origin main

      - name: Check if main is merged into feature branch
        id: check
        run: |
          echo "==================================="
          echo "ğŸ” æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã¨ã®åŒæœŸãƒã‚§ãƒƒã‚¯"
          echo "==================================="

          # mainãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          MAIN_LATEST=$(git rev-parse origin/main)
          echo "ğŸ“ mainãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: ${MAIN_LATEST:0:7}"

          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«mainã®æœ€æ–°ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git merge-base --is-ancestor origin/main HEAD; then
            echo "âœ… SUCCESS: featureãƒ–ãƒ©ãƒ³ãƒã¯æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’å«ã‚“ã§ã„ã¾ã™"
            echo "sync_status=updated" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERROR: featureãƒ–ãƒ©ãƒ³ãƒã¯æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’å«ã‚“ã§ã„ã¾ã›ã‚“"
            echo ""
            echo "ğŸ“‹ å¿…è¦ãªå¯¾å¿œ:"
            echo "1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ã“ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
            echo "   git checkout ${{ github.head_ref }}"
            echo ""
            echo "2. æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’pull"
            echo "   git pull origin main"
            echo ""
            echo "3. å¤‰æ›´ã‚’push"
            echo "   git push origin ${{ github.head_ref }}"
            echo ""
            echo "==================================="
            echo "sync_status=outdated" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Comment on PR if outdated
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `## âš ï¸ ãƒãƒ¼ã‚¸è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“

            ã“ã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã«ã¯ã€æœ€æ–°ã®\`main\`ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’å–ã‚Šè¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

            ### ğŸ“ å¯¾å¿œæ‰‹é †:

            \`\`\`bash
            # 1. ã“ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            git checkout ${{ github.head_ref }}

            # 2. æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’pull
            git pull origin main

            # 3. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã¯è§£æ±º

            # 4. å¤‰æ›´ã‚’push
            git push origin ${{ github.head_ref }}
            \`\`\`

            ### ğŸ’¡ GitHub UIã‹ã‚‰æ›´æ–°ã™ã‚‹å ´åˆ:
            ã“ã®PRãƒšãƒ¼ã‚¸ã®ä¸‹éƒ¨ã«ã‚ã‚‹ **"Update branch"** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚

            ---
            *ã“ã®ãƒã‚§ãƒƒã‚¯ã¯è‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚æ›´æ–°å¾Œã€CIãŒå†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
